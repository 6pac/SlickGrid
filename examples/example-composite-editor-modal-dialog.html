<!DOCTYPE HTML>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <link rel="shortcut icon" type="image/ico" href="favicon.ico" />
  <title>SlickGrid example: CompositeEditor</title>
  <link rel="stylesheet" href="../slick.grid.css" type="text/css" />
  <link rel="stylesheet" href="../css/smoothness/jquery-ui.css" type="text/css" />
  <link rel="stylesheet" href="examples.css" type="text/css" />
  <style>
    .cell-title {
      font-weight: bold;
    }

    .cell-effort-driven {
      text-align: center;
    }

    .close {
      float: right;
      font-size: 1.5rem;
      font-weight: 700;
      line-height: 1;
      color: #000;
      text-shadow: 0 1px 0 #fff;
      opacity: .5;
    }

    .modal {
      z-index: 10000;
      display: inline-block;
      border: 1px solid black;
      margin: 8px;
      background: #efefef;
      box-shadow: 0px 0px 15px black;
      position: absolute;
      top: 10px;
      left: 150px;
      width: 300px;
    }

    .modal h5 {
      font-size: 18px;
      margin: 0;
      line-height: 20px;
    }

    .modal-body {
      padding: 8px;
    }

    .modal-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      padding: 8px;
      height: 25px;
      border-bottom: 1px solid #c9c9c9;
    }

    .modal-footer {
      margin-top: 5px;
      border-top: 1px solid #c9c9c9;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-end;
      padding: 8px;
    }

    .modal-footer button {
      margin-right: 5px;
    }

    .item-details-label {
      margin-left: 10px;
      margin-top: 15px;
      display: block;
      font-weight: bold;
    }

    .item-details-editor-container {
      border: 1px solid silver;
      background: white;
      display: block;
      margin: 10px;
      margin-top: 4px;
      padding: 0;
      padding-left: 4px;
      padding-right: 4px;
      line-height: 20px;
    }

    .item-details-editor-container textarea {
      height: inherit;
    }

    .slick-editor-detail-validation {
      color: red;
      margin-left: 12px;
    }

    .slick-large-editor-text {
      border: 1px solid #d2d2d2;
      padding: 6px;

    }

    .slick-large-editor-text textarea {
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>
  <div style="position:relative">
    <div style="width:600px;">
      <div id="myGrid" style="width:100%;height:500px;"></div>
    </div>
    
    <div class="options-panel">
      <h2>Demonstrates:</h2>
      <ul>
        <li>using a CompositeEditor to implement detached item edit form</li>
      </ul>

      <h2>Options:</h2>
      <button onclick="openDetails()">Open Item Edit for active row</button>

      <h2>View Source:</h2>
      <ul>
        <li><A href="https://github.com/6pac/SlickGrid/blob/master/examples/example-composite-editor-item-details.html"
            target="_sourcewindow"> View the source for this example on Github</a></li>
      </ul>
    </div>
  </div>

  <script src="../lib/firebugx.js"></script>

  <script src="../lib/jquery-1.12.4.min.js"></script>
  <script src="../lib/jquery-ui.min.js"></script>
  <script src="../lib/jquery.event.drag-2.3.0.js"></script>

  <script src="../slick.core.js"></script>
  <script src="../plugins/slick.cellrangeselector.js"></script>
  <script src="../plugins/slick.cellselectionmodel.js"></script>
  <script src="../slick.formatters.js"></script>
  <script src="../slick.editors.js"></script>
  <script src="../slick.grid.js"></script>
  <script src="../slick.compositeeditor.js"></script>

  <script>
    function taskValidator(value) {
      if (value === null || value === undefined || !value.length) {
        return { valid: false, msg: 'This is a required field' };
      } else if (!/^task\s\d+$/i.test(value)) {
        return { valid: false, msg: 'Your title is invalid, it must start with "Task" followed by a number' };
      }
      return { valid: true, msg: '' };
    }

    var grid;
    var data = [];
    var columns = [
      { id: "title", name: "Title", field: "title", width: 120, cssClass: "cell-title", editor: Slick.Editors.Text, validator: taskValidator },
      { id: "desc", name: "Description", field: "description", width: 100, editor: Slick.Editors.LongText },
      { id: "duration", name: "Duration", field: "duration", editor: Slick.Editors.Text },
      { id: "percent", name: "% Complete", field: "percentComplete", width: 80, resizable: false, formatter: Slick.Formatters.PercentCompleteBar, editor: Slick.Editors.PercentComplete },
      { id: "start", name: "Start", field: "start", minWidth: 60, editor: Slick.Editors.Date },
      { id: "finish", name: "Finish", field: "finish", minWidth: 60, editor: Slick.Editors.Date },
      { id: "effort-driven", name: "Effort Driven", width: 80, minWidth: 20, maxWidth: 80, cssClass: "cell-effort-driven", field: "effortDriven", formatter: Slick.Formatters.Checkmark, editor: Slick.Editors.Checkbox }
    ];
    var options = {
      editable: true,
      enableAddRow: true,
      enableCellNavigation: true,
      asyncEditorLoading: false,
      autoEdit: false
    };

    function validateCurrentEditor() {
      var currentEditor = this.grid.getCellEditor();
      if (currentEditor) {
        currentEditor.validate();
      }
    }

    function openDetails() {
      if (grid.getEditorLock().isActive() && !grid.getEditorLock().commitCurrentEdit()) {
        return;
      }

      var $modal = $(`<div class="modal"></div>`);
      var $modalHeader = $(`<div class="modal-header"><h5>Composite Editor</h5>
      <button type="button" class="close" data-action="cancel" aria-label="Close">
          <span aria-hidden="true">X</span>
        </button></div>`);
      var $modalBody = $(`<div class="modal-body"></div>`);

      for (const column of columns) {
        if (column.editor) {
          var $templateItem = $(`<div class="item-details-label">${column.name}</div>
        <div class="item-details-editor-container" data-editorid="${column.id}" style="height: ${column.id === 'desc' ? 'inherit' : '20px'}"></div>
        <div class="slick-editor-detail-validation editor-${column.id}"></div>`);
          $templateItem.appendTo($modalBody);
        }
      }
      const $modalFooter = $(`<div class="modal-footer">
      <button data-action="save">Save</button>
      <button data-action="cancel">Cancel</button>
    </div>`);

      $modalHeader.appendTo($modal);
      $modalBody.appendTo($modal);
      $modalFooter.appendTo($modal);
      $modal.appendTo("body");

      $modal.on('focusout', validateCurrentEditor.bind(this));
      $modal.on('keydown', (function (e) {
        if (e.which == Slick.keyCode.ESCAPE) {
          grid.getEditController().cancelCurrentEdit();
          e.stopPropagation();
          e.preventDefault();
        } else if (e.which === Slick.keyCode.TAB) {
          validateCurrentEditor();
        }
      }));

      $modal.find("[data-action=save]").click(function () {
        grid.getEditController().commitCurrentEdit();
      });

      $modal.find("[data-action=cancel]").click(function () {
        grid.getEditController().cancelCurrentEdit();
      });

      $modal.find("[data-action=close]").click(function () {
        grid.getEditController().cancelCurrentEdit();
      });

      var containers = $.map(columns, function (c) {
        return $modal.find("[data-editorid=" + c.id + "]");
      });

      var compositeEditor = new Slick.CompositeEditor(
        columns,
        containers,
        {
          destroy: function () {
            $modal.remove();
          }
        }
      );

      grid.editActiveCell(compositeEditor);
    }

    $(function () {
      for (var i = 0; i < 500; i++) {
        var d = (data[i] = {});

        d["title"] = "Task " + i;
        d["description"] = "This is a sample task description.\n  It can be multiline";
        d["duration"] = "5 days";
        d["percentComplete"] = Math.round(Math.random() * 100);
        d["start"] = "01/01/2009";
        d["finish"] = "01/05/2009";
        d["effortDriven"] = (i % 5 == 0);
      }

      grid = new Slick.Grid("#myGrid", data, columns, options);

      grid.onAddNewRow.subscribe(function (e, args) {
        var item = args.item;
        var column = args.column;
        grid.invalidateRow(data.length);
        data.push(item);
        grid.updateRowCount();
        grid.render();
      });


      grid.onValidationError.subscribe(function (e, args) {
        // handle validation errors originating from the CompositeEditor
        if (args.validationResults) {
          let errorMsg = args.validationResults.msg || '';
          if (args.editor && (args.editor instanceof Slick.CompositeEditor)) {
            if (args.validationResults.errors) {
              errorMsg += '\n';
              args.validationResults.errors.forEach(function (error, errorIndex) {
                const columnName = error.editor.args.column.id;
                errorMsg += `${columnName.toUpperCase()}: ${error.msg}`;
              });
            }
            console.log(errorMsg);
          }
        } else {
          alert(errorMessages);
        }
      });

      grid.setActiveCell(0, 0);
    })
  </script>
</body>

</html>