<!DOCTYPE HTML>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <link rel="shortcut icon" type="image/ico" href="favicon.ico" />
  <title>SlickGrid example 5: Tree Data with Filters</title>
  <link rel="stylesheet" href="../slick.grid.css" type="text/css" />
  <link rel="stylesheet" href="../css/smoothness/jquery-ui.css" type="text/css" />
  <link rel="stylesheet" href="examples.css" type="text/css" />
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
    crossorigin="anonymous">
  <style>
    .fa {
      font-size: 12px;
      font-weight: 500;
    }

    .fa-folder-o,
    .fa-folder-open-o {
      color: orange;
    }

    .fa-file-pdf-o {
      color: #f14668;
    }

    .fa-file-audio-o {
      color: #3298dc;
    }

    .fa-file-excel-o {
      color: #1E9F75;
    }

    .cell-title {
      font-weight: bold;
    }

    .cell-effort-driven {
      text-align: center;
    }

    .slick-group-toggle {
      height: 9px;
      width: 9px;
      display: inline-block;
    }

    .slick-group-toggle.expand {
      background: url(../images/expand.gif) no-repeat center center;
    }

    .slick-group-toggle.collapse {
      background: url(../images/collapse.gif) no-repeat center center;
    }

    .slick-headerrow-column {
      background: #eff2f3;
      text-overflow: clip;
      -moz-box-sizing: border-box;
      box-sizing: border-box;
    }

    .slick-headerrow-column input {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      -moz-box-sizing: border-box;
      box-sizing: border-box;
    }
  </style>
</head>

<body>
  <table width="100%">
    <tr>
      <div>ColumnFilters: <span id="currentColumnFilters"></span></div>
      <td valign="top" width="50%">
        <div id="myGrid" style="width:600px;height:500px;"></div>
      </td>
      <td valign="top">
        <h2>Demonstrates:</h2>
        <ul>
          <li>implementing expand/collapse as a filter for DataView</li>
        </ul>

        <h2>View Source:</h2>
        <ul>
          <li><A href="https://github.com/6pac/SlickGrid/blob/master/examples/example5-collapsing.html"
              target="_sourcewindow"> View the source for this example on Github</a></li>
        </ul>
      </td>
    </tr>
  </table>

  <script src="../lib/firebugx.js"></script>

  <script src="../lib/jquery-1.12.4.min.js"></script>
  <script src="../lib/jquery-ui.min.js"></script>
  <script src="../lib/jquery.event.drag-2.3.0.js"></script>

  <script src="../slick.core.js"></script>
  <script src="../slick.grid.js"></script>
  <script src="../slick.dataview.js"></script>

  <script>
    var columnFilters = {};
    var tmpPreFilteredData = [];
    var dataView;
    var grid;
    var data = [];
    var columns = [
      { id: 'file', name: 'Files', field: 'file', width: 150, formatter: treeFormatter, sortable: true, },
      { id: 'dateModified', name: 'Date Modified', field: 'dateModified', sortable: true, minWidth: 90, },
      { id: 'size', name: 'Size', field: 'size', sortable: true, minWidth: 90, formatter: function (row, cell, value) { return isNaN(value) ? '' : `${value} MB`; } },
    ];

    var gridOptions = {
      editable: true,
      enableAddRow: true,
      enableCellNavigation: true,
      asyncEditorLoading: false,
      showHeaderRow: true,
      explicitInitialization: true,
      headerRowHeight: 30,
    };

    function filterMyFiles(inputArray, columnFilters) {
      const myObj = {};
      for (let i = 0; i < inputArray.length; i++) {
        myObj[inputArray[i].id] = inputArray[i];
        //as the filtered data is then used again as each subsequent letter
        //we need to delete the ._used property, otherwise the logic below
        //in the while loop (which checks for parents) doesn't work:
        delete myObj[inputArray[i].id]._used;
      }

      const filteredChildrenAndParents = [];
      for (let i = 0; i < inputArray.length; i++) {
        const a = inputArray[i];
        let matchFilter = true;
        for (const key in columnFilters) {
          if (a.hasOwnProperty(key)) {
            //check case insensitive:
            const strContains = String(a[key]).toLowerCase().includes(columnFilters[key].toLowerCase());
            //RegEx explained: https://regex101.com/r/w74GSk/13:
            const re = /(?:(?:^|[-+<>=_*/])(?:\s*-?\d+(\.\d+)?(?:[eE][+-<>=]?\d+)?\s*))+$/;
            // according to mozilla using Function("return something") is better then eval() - and doesn't use eval
            //https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/eval#Never_use_eval!
            const comparison = re.test(columnFilters[key]) && Function('return ' + a[key] + columnFilters[key])();
            if (strContains || comparison) {
              // don't return true as need to check other keys in columnFilters
            } else {
              matchFilter = false;
              continue;
            }
          } else {
            matchFilter = false;
            continue;
          }
        }
        if (matchFilter) {
          const len = filteredChildrenAndParents.length;
          //add child (id):
          filteredChildrenAndParents.splice(len, 0, a.id);
          let parent = myObj[a.parentId] || false;
          while (parent) {
            //only add parent (id) if not already added:
            parent._used || filteredChildrenAndParents.splice(len, 0, parent.id);
            //mark each parent as used so not used again:
            myObj[parent.id]._used = true;
            //try to find parent of the current parent, if exists:
            parent = myObj[parent.parentId] || false;
          }
        }
      }

      // no longer has duplicate values (due to using ._used flag), so no need to dedupe array
      return filteredChildrenAndParents;
    }

    function myFilter(item, columnFilters) {
      if (item.parentId !== null) {
        let parent = dataView.getItemById(item.parentId);
        while (parent) {
          if (parent.__collapsed) {
            return false;
          }
          parent = dataView.getItemById(parent.parentId);
        }
      }

      for (var columnId in columnFilters) {
        if (Array.isArray(tmpPreFilteredData)) {
          // NOTE: we are comparing against object id, perhaps "filterMyFiles()" could simply store IDs, that would be faster??
          //var itemFound = tmpPreFilteredData.find(function (obj) { return obj.id == item.id });

          //Yes I think its possibly faster to use includes on a number array than find on an object array:
          var itemFound = tmpPreFilteredData.includes(item.id);
          return itemFound ? true : false;
        }
      }
      return true;
    }

    function onSearchKeyupEvent(e) {
      var columnId = $(this).data("columnId");
      if (columnId != null) {
        var searchString = $.trim($(this).val());
        if (searchString === '') {
          delete columnFilters[columnId];
        } else {
          columnFilters[columnId] = searchString;
        }

        // display current columnFilters in the DOM
        document.querySelector('#currentColumnFilters').textContent = JSON.stringify(columnFilters);

        // step1. filter the files 
        tmpPreFilteredData = filterMyFiles(data, columnFilters);

        // step2. call the refresh so it does the final filtering of which rows should persist
        // calling dataview refresh is what triggers the myFilter()
        dataView.refresh();
      }
    }

    $(function () {
      var indent = 0;
      var parents = [];

      // prepare the data
      data = [
        { id: 21, file: "Documents", parentId: null, __treeLevel: 0 },
        { id: 9, file: "misc", __treeLevel: 1, parentId: 21 },
        { id: 10, file: "something.txt", dateModified: "2015-02-26", size: 0.4, __treeLevel: 2, parentId: 9, },
        { id: 4, file: "pdf", __treeLevel: 1, parentId: 21 },
        { id: 6, file: "internet-bill.pdf", dateModified: "2015-05-12", size: 1.4, __treeLevel: 2, parentId: 4, },
        { id: 5, file: "map.pdf", dateModified: "2015-05-21", size: 3.1, __treeLevel: 2, parentId: 4, },
        { id: 22, file: "map2.pdf", dateModified: "2015-05-21", size: 2.9, __treeLevel: 2, parentId: 4, },
        { id: 2, file: "txt", __treeLevel: 1, parentId: 21 },
        { id: 3, file: "todo.txt", dateModified: "2015-05-12", size: 0.7, __treeLevel: 2, parentId: 2, },
        { id: 7, file: "xls", __treeLevel: 1, parentId: 21 },
        { id: 8, file: "compilation.xls", dateModified: "2014-10-02", size: 2.3, __treeLevel: 2, parentId: 7, },
        { id: 11, file: "Music", __treeLevel: 0, parentId: null },
        { id: 12, file: "mp3", __treeLevel: 1, parentId: 11 },
        { id: 14, file: "pop", __treeLevel: 2, parentId: 12 },
        { id: 15, file: "theme.mp3", dateModified: "2015-03-01", size: 85, __treeLevel: 3, parentId: 14, },
        { id: 16, file: "rock", __treeLevel: 2, parentId: 12 },
        { id: 17, file: "soft.mp3", dateModified: "2015-05-13", size: 98, __treeLevel: 3, parentId: 16, },
        { id: 18, file: "something.txt", dateModified: "2015-03-03", size: 90, __treeLevel: 0, parentId: null, },
      ];

      // initialize the model
      dataView = new Slick.Data.DataView({ inlineFilters: false });

      // initialize the grid
      grid = new Slick.Grid("#myGrid", dataView, columns, gridOptions);

      $(grid.getHeaderRow()).on("change keyup", ":input", onSearchKeyupEvent);

      grid.onHeaderRowCellRendered.subscribe(function (e, args) {
        $(args.node).empty();
        $("<input type='text'>")
          .data("columnId", args.column.id)
          .val(columnFilters[args.column.id])
          .appendTo(args.node);
      });

      grid.onClick.subscribe(function (e, args) {
        if ($(e.target).hasClass("slick-group-toggle")) {
          var item = dataView.getItem(args.row);
          if (item) {
            if (!item.__collapsed) {
              item.__collapsed = true;
            } else {
              item.__collapsed = false;
            }

            dataView.updateItem(item.id, item);
            grid.invalidate();
          }
          e.stopImmediatePropagation();
        }
      });


      // wire up model events to drive the grid
      dataView.onRowCountChanged.subscribe(function (e, args) {
        grid.updateRowCount();
        grid.render();
      });

      dataView.onRowsChanged.subscribe(function (e, args) {
        grid.invalidateRows(args.rows);
        grid.render();
      });

      grid.init();
      dataView.beginUpdate();
      dataView.setItems(data);
      dataView.setFilterArgs(columnFilters);
      dataView.setFilter(myFilter);
      dataView.endUpdate();
    });

    function treeFormatter(row, cell, value, columnDef, dataContext, grid) {
      const treeLevelPropName = '__treeLevel';
      if (value === null || value === undefined || dataContext === undefined) {
        return '';
      }
      const dataView = grid.getData();
      const data = dataView.getItems();
      const identifierPropName = dataView.getIdPropertyName() || 'id';
      const idx = dataView.getIdxById(dataContext[identifierPropName]);
      const prefix = getFileIcon(value);

      value = value.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      const spacer = `<span style="display:inline-block; width:${(15 * dataContext[treeLevelPropName])}px;"></span>`;

      if (data[idx + 1] && data[idx + 1][treeLevelPropName] > data[idx][treeLevelPropName]) {
        const folderPrefix = `<i class="fa ${dataContext.__collapsed ? 'fa-folder-o' : 'fa-folder-open-o'}"></i>`;
        if (dataContext.__collapsed) {
          return `${spacer} <span class="slick-group-toggle collapsed" level="${dataContext[treeLevelPropName]}"></span>${folderPrefix} ${prefix}&nbsp;${value}`;
        } else {
          return `${spacer} <span class="slick-group-toggle expanded" level="${dataContext[treeLevelPropName]}"></span>${folderPrefix} ${prefix}&nbsp;${value}`;
        }
      } else {
        return `${spacer} <span class="slick-group-toggle" level="${dataContext[treeLevelPropName]}"></span>${prefix}&nbsp;${value}`;
      }
    }

    function getFileIcon(value) {
      let prefix = '';
      if (value.includes('.pdf')) {
        prefix = '<i class="fa fa-file-pdf-o"></i>';
      } else if (value.includes('.txt')) {
        prefix = '<i class="fa fa-file-o"></i>';
      } else if (value.includes('.xls')) {
        prefix = '<i class="fa fa-file-excel-o"></i>';
      } else if (value.includes('.mp3')) {
        prefix = '<i class="fa fa-file-audio-o"></i>';
      }
      return prefix;
    }
  </script>
</body>

</html>