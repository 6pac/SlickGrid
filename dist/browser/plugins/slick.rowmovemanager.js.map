{
  "version": 3,
  "sources": ["../../../src/plugins/slick.rowmovemanager.ts"],
  "sourcesContent": ["import { SlickEvent as SlickEvent_, SlickEventData as SlickEventData_, SlickEventHandler as SlickEventHandler_, Utils as Utils_ } from '../slick.core';\nimport type { Column, DOMEvent, DragRowMove, FormatterResultWithHtml, RowMoveManagerOption, UsabilityOverrideFn } from '../models/index';\nimport type { SlickGrid } from '../slick.grid';\n\n// for (iife) load Slick methods from global Slick object, or use imports for (esm)\nconst SlickEvent = IIFE_ONLY ? Slick.Event : SlickEvent_;\nconst SlickEventHandler = IIFE_ONLY ? Slick.EventHandler : SlickEventHandler_;\nconst Utils = IIFE_ONLY ? Slick.Utils : Utils_;\n\n/**\n * Row Move Manager options:\n *    containerCssClass:        A CSS class to be added to the cell container.\n *    cssClass:                 A CSS class to be added to the div of the cell formatter.\n *    columnId:                 Column definition id (defaults to \"_move\")\n *    cancelEditOnDrag:         Do we want to cancel any Editing while dragging a row (defaults to false)\n *    disableRowSelection:      Do we want to disable the row selection? (defaults to false)\n *    hideRowMoveShadow:        Do we want to hide the row move shadow clone? (defaults to true)\n *    rowMoveShadowMarginTop:   When row move shadow is shown, optional margin-top (defaults to 0)\n *    rowMoveShadowMarginLeft:  When row move shadow is shown, optional margin-left (defaults to 0)\n *    rowMoveShadowOpacity:     When row move shadow is shown, what is its opacity? (defaults to 0.95)\n *    rowMoveShadowScale:       When row move shadow is shown, what is its size scale? (default to 0.75)\n *    singleRowMove:            Do we want a single row move? Setting this to false means that it's a multple row move (defaults to false)\n *    width:                    Width of the column\n *    usabilityOverride:        Callback method that user can override the default behavior of the row being moveable or not\n *\n */\n\nexport class SlickRowMoveManager {\n  // --\n  // public API\n  pluginName = 'RowMoveManager' as const;\n  onBeforeMoveRows = new SlickEvent<{ grid: SlickGrid; rows: number[]; insertBefore: number; }>();\n  onMoveRows = new SlickEvent<{ grid: SlickGrid; rows: number[]; insertBefore: number; }>();\n\n  // --\n  // protected props\n  protected _grid!: SlickGrid;\n  protected _canvas!: HTMLElement;\n  protected _dragging = false;\n  protected _eventHandler: SlickEventHandler_;\n  protected _usabilityOverride?: UsabilityOverrideFn;\n  protected _options: RowMoveManagerOption;\n  protected _defaults: RowMoveManagerOption = {\n    columnId: '_move',\n    cssClass: undefined,\n    cancelEditOnDrag: false,\n    disableRowSelection: false,\n    hideRowMoveShadow: true,\n    rowMoveShadowMarginTop: 0,\n    rowMoveShadowMarginLeft: 0,\n    rowMoveShadowOpacity: 0.95,\n    rowMoveShadowScale: 0.75,\n    singleRowMove: false,\n    width: 40,\n  };\n\n  constructor(options: Partial<RowMoveManagerOption>) {\n    this._options = Utils.extend(true, {}, this._defaults, options);\n    this._eventHandler = new SlickEventHandler();\n  }\n\n\n  init(grid: SlickGrid) {\n    this._grid = grid;\n    this._canvas = this._grid.getCanvasNode();\n\n    // user could override the expandable icon logic from within the options or after instantiating the plugin\n    if (typeof this._options?.usabilityOverride === 'function') {\n      this.usabilityOverride(this._options.usabilityOverride);\n    }\n\n    this._eventHandler\n      .subscribe(this._grid.onDragInit, this.handleDragInit.bind(this))\n      .subscribe(this._grid.onDragStart, this.handleDragStart.bind(this))\n      .subscribe(this._grid.onDrag, this.handleDrag.bind(this))\n      .subscribe(this._grid.onDragEnd, this.handleDragEnd.bind(this));\n  }\n\n  destroy() {\n    this._eventHandler.unsubscribeAll();\n  }\n\n  setOptions(newOptions: Partial<RowMoveManagerOption>) {\n    this._options = Utils.extend({}, this._options, newOptions);\n  }\n\n  protected handleDragInit(e: SlickEventData_) {\n    // prevent the grid from cancelling drag'n'drop by default\n    e.stopImmediatePropagation();\n  }\n\n  protected handleDragStart(e: DOMEvent<HTMLDivElement>, dd: DragRowMove): boolean | void {\n    const cell = this._grid.getCellFromEvent(e) || { cell: -1, row: -1 };\n    const currentRow = cell?.row;\n    const dataContext = this._grid.getDataItem(currentRow);\n\n    if (!this.checkUsabilityOverride(currentRow, dataContext, this._grid)) {\n      return;\n    }\n\n    if (this._options.cancelEditOnDrag && this._grid.getEditorLock().isActive()) {\n      this._grid.getEditorLock().cancelCurrentEdit();\n    }\n\n    if (this._grid.getEditorLock().isActive() || !this.isHandlerColumn(cell.cell)) {\n      return false;\n    }\n\n    this._dragging = true;\n    e.stopImmediatePropagation();\n\n    // optionally create a shadow element of the row so that we can see all the time which row exactly we're dragging\n    if (!this._options.hideRowMoveShadow) {\n      const slickRowElm = this._grid.getCellNode(cell.row, cell.cell)?.closest<HTMLDivElement>('.slick-row');\n      if (slickRowElm) {\n        dd.clonedSlickRow = slickRowElm.cloneNode(true) as HTMLDivElement;\n        dd.clonedSlickRow.classList.add('slick-reorder-shadow-row');\n        dd.clonedSlickRow.style.display = 'none';\n        dd.clonedSlickRow.style.marginLeft = Number(this._options.rowMoveShadowMarginLeft || 0) + 'px';\n        dd.clonedSlickRow.style.marginTop = Number(this._options.rowMoveShadowMarginTop || 0) + 'px';\n        dd.clonedSlickRow.style.opacity = `${this._options.rowMoveShadowOpacity || 0.95}`;\n        dd.clonedSlickRow.style.transform = `scale(${this._options.rowMoveShadowScale || 0.75})`;\n        this._canvas.appendChild(dd.clonedSlickRow);\n      }\n    }\n\n    let selectedRows = this._options.singleRowMove ? [cell.row] : this._grid.getSelectedRows();\n    if (selectedRows.length === 0 || !selectedRows.some(selectedRow => selectedRow === cell.row)) {\n      selectedRows = [cell.row];\n      if (!this._options.disableRowSelection) {\n        this._grid.setSelectedRows(selectedRows);\n      }\n    }\n\n    const rowHeight = this._grid.getOptions().rowHeight;\n\n    dd.selectedRows = selectedRows;\n\n    dd.selectionProxy = document.createElement('div');\n    dd.selectionProxy.className = 'slick-reorder-proxy';\n    dd.selectionProxy.style.display = 'none';\n    dd.selectionProxy.style.position = 'absolute';\n    dd.selectionProxy.style.zIndex = '99999';\n    dd.selectionProxy.style.width = `${this._canvas.clientWidth}px`;\n    dd.selectionProxy.style.height = `${rowHeight! * selectedRows.length}px`;\n    this._canvas.appendChild(dd.selectionProxy);\n\n    dd.guide = document.createElement('div');\n    dd.guide.className = 'slick-reorder-guide';\n    dd.guide.style.position = 'absolute';\n    dd.guide.style.zIndex = '99999';\n    dd.guide.style.width = `${this._canvas.clientWidth}px`;\n    dd.guide.style.top = `-1000px`;\n    this._canvas.appendChild(dd.guide);\n\n    dd.insertBefore = -1;\n  }\n\n  protected handleDrag(evt: SlickEventData_, dd: DragRowMove): boolean | void {\n    if (!this._dragging) {\n      return;\n    }\n\n    evt.stopImmediatePropagation();\n    const e = evt.getNativeEvent<MouseEvent | TouchEvent>();\n\n    const targetEvent = (e as TouchEvent)?.touches?.[0] ?? e;\n    const top = targetEvent.pageY - (Utils.offset(this._canvas)?.top ?? 0);\n    dd.selectionProxy.style.top = `${top - 5}px`;\n    dd.selectionProxy.style.display = 'block';\n\n    // if the row move shadow is enabled, we'll also make it follow the mouse cursor\n    if (dd.clonedSlickRow) {\n      dd.clonedSlickRow.style.top = `${top - 6}px`;\n      dd.clonedSlickRow.style.display = 'block';\n    }\n\n    const insertBefore = Math.max(0, Math.min(Math.round(top / this._grid.getOptions().rowHeight!), this._grid.getDataLength()));\n    if (insertBefore !== dd.insertBefore) {\n      const eventData = {\n        grid: this._grid,\n        rows: dd.selectedRows,\n        insertBefore\n      };\n\n      if (this.onBeforeMoveRows.notify(eventData).getReturnValue() === false) {\n        dd.canMove = false;\n      } else {\n        dd.canMove = true;\n      }\n\n      // if there's a UsabilityOverride defined, we also need to verify that the condition is valid\n      if (this._usabilityOverride && dd.canMove) {\n        const insertBeforeDataContext = this._grid.getDataItem(insertBefore);\n        dd.canMove = this.checkUsabilityOverride(insertBefore, insertBeforeDataContext, this._grid);\n      }\n\n      // if the new target is possible we'll display the dark blue bar (representin the acceptability) at the target position\n      // else it won't show up (it will be off the screen)\n      if (!dd.canMove) {\n        dd.guide.style.top = '-1000px';\n      } else {\n        dd.guide.style.top = `${insertBefore * (this._grid.getOptions().rowHeight || 0)}px`;\n      }\n\n      dd.insertBefore = insertBefore;\n    }\n  }\n\n  protected handleDragEnd(e: SlickEventData_, dd: DragRowMove) {\n    if (!this._dragging) {\n      return;\n    }\n    this._dragging = false;\n    e.stopImmediatePropagation();\n\n    dd.guide?.remove();\n    dd.selectionProxy?.remove();\n    dd.clonedSlickRow?.remove();\n\n    if (dd.canMove) {\n      const eventData = {\n        grid: this._grid,\n        rows: dd.selectedRows,\n        insertBefore: dd.insertBefore\n      };\n      // TODO:  this._grid.remapCellCssClasses ?\n      this.onMoveRows.notify(eventData);\n    }\n  }\n\n  getColumnDefinition(): Column {\n    const columnId = String(this._options?.columnId ?? this._defaults.columnId);\n\n    return {\n      id: columnId,\n      name: '',\n      field: 'move',\n      behavior: 'selectAndMove',\n      excludeFromColumnPicker: true,\n      excludeFromGridMenu: true,\n      excludeFromHeaderMenu: true,\n      resizable: false,\n      selectable: false,\n      width: this._options.width || 40,\n      formatter: this.moveIconFormatter.bind(this)\n    };\n  }\n\n  protected moveIconFormatter(row: number, _cell: number, _val: any, _column: Column, dataContext: any, grid: SlickGrid): FormatterResultWithHtml | string {\n    if (!this.checkUsabilityOverride(row, dataContext, grid)) {\n      return '';\n    } else {\n      const iconElm = document.createElement('div');\n      iconElm.className = this._options.cssClass || '';\n      return {\n        addClasses: `cell-reorder dnd ${this._options.containerCssClass || ''}`,\n        html: iconElm\n      };\n    }\n  }\n\n  protected checkUsabilityOverride(row: number, dataContext: any, grid: SlickGrid) {\n    if (typeof this._usabilityOverride === 'function') {\n      return this._usabilityOverride(row, dataContext, grid);\n    }\n    return true;\n  }\n\n  /**\n   * Method that user can pass to override the default behavior or making every row moveable.\n   * In order word, user can choose which rows to be an available as moveable (or not) by providing his own logic show/hide icon and usability.\n   * @param overrideFn: override function callback\n   */\n  usabilityOverride(overrideFn: UsabilityOverrideFn) {\n    this._usabilityOverride = overrideFn;\n  }\n\n  isHandlerColumn(columnIndex: number | string) {\n    return /move|selectAndMove/.test(this._grid.getColumns()[+columnIndex].behavior || '');\n  }\n}\n\n// extend Slick namespace on window object when building as iife\nif (IIFE_ONLY && window.Slick) {\n  Utils.extend(true, window, {\n    Slick: {\n      RowMoveManager: SlickRowMoveManager\n    }\n  });\n}\n\n"],
  "mappings": "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",
  "names": []
}
