{
  "version": 3,
  "sources": ["../../../src/plugins/slick.state.ts"],
  "sourcesContent": ["import { SlickEvent as SlickEvent_, Utils as Utils_ } from '../slick.core.js';\r\nimport type { Column, ColumnSort, SlickPlugin } from '../models/index.js';\r\nimport type { SlickGrid } from '../slick.grid.js';\r\n\r\n// for (iife) load Slick methods from global Slick object, or use imports for (esm)\r\nconst SlickEvent = IIFE_ONLY ? Slick.Event : SlickEvent_;\r\nconst Utils = IIFE_ONLY ? Slick.Utils : Utils_;\r\n\r\nexport interface SlickStateOption {\r\n  /** optional grid state clientId */\r\n  cid: string;\r\n\r\n  /** default columns when loadnig the grid */\r\n  defaultColumns: Column[];\r\n\r\n  /** local storage key prefix */\r\n  key_prefix: string;\r\n\r\n  /** should we scroll the grid into view? */\r\n  scrollRowIntoView: boolean;\r\n\r\n  /** local storage wrapper */\r\n  storage: LocalStorageWrapper;\r\n}\r\n\r\nexport interface CurrentState {\r\n  columns: Array<{ id: string | number; width: number | undefined; }>;\r\n  sortcols: ColumnSort[];\r\n  userData: any;\r\n  viewport: { top: number; bottom: number; leftPx: number; rightPx: number; };\r\n}\r\n\r\nclass LocalStorageWrapper {\r\n  protected localStorage = window.localStorage;\r\n\r\n  constructor() {\r\n    if (typeof localStorage === 'undefined') {\r\n      console.error('localStorage is not available. slickgrid statepersistor disabled.');\r\n    }\r\n  }\r\n\r\n  get<T = any>(key: string) {\r\n    return new Promise<T>((resolve, reject) => {\r\n      if (!localStorage) {\r\n        reject('missing localStorage');\r\n        return;\r\n      }\r\n      try {\r\n        const d = localStorage.getItem(key);\r\n        if (d) {\r\n          return resolve(JSON.parse(d) as T);\r\n        }\r\n        resolve({} as T);\r\n      } catch (exc) {\r\n        reject(exc);\r\n      }\r\n    });\r\n  }\r\n\r\n  set(key: string, obj: any) {\r\n    if (!localStorage) { return; }\r\n    if (typeof obj !== 'undefined') {\r\n      obj = JSON.stringify(obj);\r\n    }\r\n    localStorage.setItem(key, obj);\r\n  }\r\n};\r\n\r\nexport class SlickState implements SlickPlugin {\r\n  // --\r\n  // public API\r\n  pluginName = 'State' as const;\r\n  onStateChanged = new SlickEvent<CurrentState>('onStateChanged');\r\n\r\n  // --\r\n  // protected props\r\n  protected _grid!: SlickGrid;\r\n  protected _cid = '';\r\n  protected _store: LocalStorageWrapper;\r\n  protected _options: SlickStateOption;\r\n  protected _state?: CurrentState;\r\n  protected _userData = {\r\n    state: null,\r\n    current: null\r\n  };\r\n\r\n  constructor(options: Partial<SlickStateOption>) {\r\n    const defaults = {\r\n      key_prefix: 'slickgrid:',\r\n      storage: new LocalStorageWrapper(),\r\n      scrollRowIntoView: true\r\n    };\r\n    this._options = Utils.extend(true, {}, defaults, options);\r\n    this._store = this._options.storage;\r\n  }\r\n\r\n  init(grid: SlickGrid) {\r\n    this._grid = grid;\r\n    this._cid = grid.cid || this._options.cid;\r\n    Utils.addSlickEventPubSubWhenDefined(grid.getPubSubService(), this);\r\n\r\n    if (this._cid) {\r\n      this._grid.onColumnsResized.subscribe(this.save.bind(this));\r\n      this._grid.onColumnsReordered.subscribe(this.save.bind(this));\r\n      this._grid.onSort.subscribe(this.save.bind(this));\r\n    } else {\r\n      console.warn('grid has no client id. state persisting is disabled.');\r\n    }\r\n  }\r\n\r\n  destroy() {\r\n    this._grid.onSort.unsubscribe(this.save.bind(this));\r\n    this._grid.onColumnsReordered.unsubscribe(this.save.bind(this));\r\n    this._grid.onColumnsResized.unsubscribe(this.save.bind(this));\r\n    this.save();\r\n  }\r\n\r\n  save() {\r\n    if (this._cid && this._store) {\r\n      this._state = {\r\n        sortcols: this.getSortColumns(),\r\n        viewport: this._grid.getViewport(),\r\n        columns: this.getColumns(),\r\n        userData: null\r\n      };\r\n      this._state.userData = this._userData.current;\r\n      this.setUserDataFromState(this._state.userData);\r\n      this.onStateChanged.notify(this._state);\r\n\r\n      return this._store.set(this._options.key_prefix + this._cid, this._state);\r\n    }\r\n  }\r\n\r\n  restore() {\r\n    return new Promise((resolve, reject) => {\r\n      if (!this._cid) {\r\n        reject('missing client id');\r\n        return;\r\n      }\r\n      if (!this._store) {\r\n        reject('missing store');\r\n        return;\r\n      }\r\n\r\n      this._store.get<CurrentState>(this._options.key_prefix + this._cid)\r\n        .then((state) => {\r\n          if (state) {\r\n            if (state.sortcols) {\r\n              this._grid.setSortColumns(state.sortcols || []);\r\n            }\r\n            if (state.viewport && this._options.scrollRowIntoView) {\r\n              this._grid.scrollRowIntoView(state.viewport.top, true);\r\n            }\r\n            if (state.columns) {\r\n              const defaultColumns = this._options.defaultColumns;\r\n              if (defaultColumns) {\r\n                const defaultColumnsLookup: Record<number | string, Column> = {};\r\n                defaultColumns.forEach((colDef) => defaultColumnsLookup[colDef.id] = colDef);\r\n\r\n                const cols: Array<{ id: string | number; width: number | undefined; }> = [];\r\n                (state.columns || []).forEach((columnDef) => {\r\n                  if (defaultColumnsLookup[columnDef.id]) {\r\n                    cols.push(Utils.extend(true, {}, defaultColumnsLookup[columnDef.id], {\r\n                      width: columnDef.width,\r\n                      headerCssClass: (columnDef as Column).headerCssClass\r\n                    }));\r\n                  }\r\n                });\r\n\r\n                state.columns = cols;\r\n              }\r\n\r\n              this._grid.setColumns(state.columns as Column[]);\r\n            }\r\n            this.setUserDataFromState(state.userData);\r\n          }\r\n          resolve(state);\r\n        })\r\n        .catch((e) => {\r\n          reject(e);\r\n        });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * allows users to add their own data to the grid state\r\n   * this function does not trigger the save() function, so the actual act of writing the state happens in save()\r\n   * therefore, it's necessary to call save() function after setting user-data\r\n   *\r\n   * @param data\r\n   * @return {State}\r\n   */\r\n  setUserData(data: any) {\r\n    this._userData.current = data;\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   *\r\n   * @internal\r\n   * @param data\r\n   * @return {State}\r\n   */\r\n  setUserDataFromState(data: any) {\r\n    this._userData.state = data;\r\n    return this.setUserData(data);\r\n  }\r\n\r\n  /**\r\n   * returns current value of user-data\r\n   * @return {Object}\r\n   */\r\n  getUserData() {\r\n    return this._userData.current;\r\n  }\r\n\r\n  /**\r\n   * returns user-data found in saved state\r\n   *\r\n   * @return {Object}\r\n   */\r\n  getStateUserData() {\r\n    return this._userData.state;\r\n  }\r\n\r\n  /**\r\n   * Sets user-data to the value read from state\r\n   * @return {State}\r\n   */\r\n  resetUserData() {\r\n    this._userData.current = this._userData.state;\r\n    return this;\r\n  }\r\n\r\n  getColumns() {\r\n    return this._grid.getColumns().map((col) => ({\r\n      id: col.id,\r\n      width: col.width\r\n    }));\r\n  }\r\n\r\n  getSortColumns() {\r\n    return this._grid.getSortColumns();\r\n  }\r\n\r\n  reset() {\r\n    this._store.set(this._options.key_prefix + this._cid, {});\r\n    this.setUserDataFromState(null);\r\n  }\r\n}\r\n\r\n// extend Slick namespace on window object when building as iife\r\nif (IIFE_ONLY && window.Slick) {\r\n  Utils.extend(true, window, {\r\n    Slick: {\r\n      State: SlickState\r\n    }\r\n  });\r\n}\r\n\r\n"],
  "mappings": ";;;;;;;AAKA,MAAM,aAAyB,MAAM,OAC/B,QAAoB,MAAM,OA0B1B,sBAAN,MAA0B;AAAA,IAGxB,cAAc;AAFd,0BAAU,gBAAe,OAAO;AAG9B,MAAI,OAAO,gBAAiB,eAC1B,QAAQ,MAAM,mEAAmE;AAAA,IAErF;AAAA,IAEA,IAAa,KAAa;AACxB,aAAO,IAAI,QAAW,CAAC,SAAS,WAAW;AACzC,YAAI,CAAC,cAAc;AACjB,iBAAO,sBAAsB;AAC7B;AAAA,QACF;AACA,YAAI;AACF,cAAM,IAAI,aAAa,QAAQ,GAAG;AAClC,cAAI;AACF,mBAAO,QAAQ,KAAK,MAAM,CAAC,CAAM;AAEnC,kBAAQ,CAAC,CAAM;AAAA,QACjB,SAAS,KAAK;AACZ,iBAAO,GAAG;AAAA,QACZ;AAAA,MACF,CAAC;AAAA,IACH;AAAA,IAEA,IAAI,KAAa,KAAU;AACzB,MAAK,iBACD,OAAO,OAAQ,gBACjB,MAAM,KAAK,UAAU,GAAG,IAE1B,aAAa,QAAQ,KAAK,GAAG;AAAA,IAC/B;AAAA,EACF,GAEa,aAAN,MAAwC;AAAA,IAkB7C,YAAY,SAAoC;AAfhD;AAAA;AAAA,wCAAa;AACb,4CAAiB,IAAI,WAAyB,gBAAgB;AAI9D;AAAA;AAAA,0BAAU;AACV,0BAAU,QAAO;AACjB,0BAAU;AACV,0BAAU;AACV,0BAAU;AACV,0BAAU,aAAY;AAAA,QACpB,OAAO;AAAA,QACP,SAAS;AAAA,MACX;AAGE,UAAM,WAAW;AAAA,QACf,YAAY;AAAA,QACZ,SAAS,IAAI,oBAAoB;AAAA,QACjC,mBAAmB;AAAA,MACrB;AACA,WAAK,WAAW,MAAM,OAAO,IAAM,CAAC,GAAG,UAAU,OAAO,GACxD,KAAK,SAAS,KAAK,SAAS;AAAA,IAC9B;AAAA,IAEA,KAAK,MAAiB;AACpB,WAAK,QAAQ,MACb,KAAK,OAAO,KAAK,OAAO,KAAK,SAAS,KACtC,MAAM,+BAA+B,KAAK,iBAAiB,GAAG,IAAI,GAE9D,KAAK,QACP,KAAK,MAAM,iBAAiB,UAAU,KAAK,KAAK,KAAK,IAAI,CAAC,GAC1D,KAAK,MAAM,mBAAmB,UAAU,KAAK,KAAK,KAAK,IAAI,CAAC,GAC5D,KAAK,MAAM,OAAO,UAAU,KAAK,KAAK,KAAK,IAAI,CAAC,KAEhD,QAAQ,KAAK,sDAAsD;AAAA,IAEvE;AAAA,IAEA,UAAU;AACR,WAAK,MAAM,OAAO,YAAY,KAAK,KAAK,KAAK,IAAI,CAAC,GAClD,KAAK,MAAM,mBAAmB,YAAY,KAAK,KAAK,KAAK,IAAI,CAAC,GAC9D,KAAK,MAAM,iBAAiB,YAAY,KAAK,KAAK,KAAK,IAAI,CAAC,GAC5D,KAAK,KAAK;AAAA,IACZ;AAAA,IAEA,OAAO;AACL,UAAI,KAAK,QAAQ,KAAK;AACpB,oBAAK,SAAS;AAAA,UACZ,UAAU,KAAK,eAAe;AAAA,UAC9B,UAAU,KAAK,MAAM,YAAY;AAAA,UACjC,SAAS,KAAK,WAAW;AAAA,UACzB,UAAU;AAAA,QACZ,GACA,KAAK,OAAO,WAAW,KAAK,UAAU,SACtC,KAAK,qBAAqB,KAAK,OAAO,QAAQ,GAC9C,KAAK,eAAe,OAAO,KAAK,MAAM,GAE/B,KAAK,OAAO,IAAI,KAAK,SAAS,aAAa,KAAK,MAAM,KAAK,MAAM;AAAA,IAE5E;AAAA,IAEA,UAAU;AACR,aAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtC,YAAI,CAAC,KAAK,MAAM;AACd,iBAAO,mBAAmB;AAC1B;AAAA,QACF;AACA,YAAI,CAAC,KAAK,QAAQ;AAChB,iBAAO,eAAe;AACtB;AAAA,QACF;AAEA,aAAK,OAAO,IAAkB,KAAK,SAAS,aAAa,KAAK,IAAI,EAC/D,KAAK,CAAC,UAAU;AACf,cAAI,OAAO;AAOT,gBANI,MAAM,YACR,KAAK,MAAM,eAAe,MAAM,YAAY,CAAC,CAAC,GAE5C,MAAM,YAAY,KAAK,SAAS,qBAClC,KAAK,MAAM,kBAAkB,MAAM,SAAS,KAAK,EAAI,GAEnD,MAAM,SAAS;AACjB,kBAAM,iBAAiB,KAAK,SAAS;AACrC,kBAAI,gBAAgB;AAClB,oBAAM,uBAAwD,CAAC;AAC/D,+BAAe,QAAQ,CAAC,WAAW,qBAAqB,OAAO,EAAE,IAAI,MAAM;AAE3E,oBAAM,OAAmE,CAAC;AAC1E,iBAAC,MAAM,WAAW,CAAC,GAAG,QAAQ,CAAC,cAAc;AAC3C,kBAAI,qBAAqB,UAAU,EAAE,KACnC,KAAK,KAAK,MAAM,OAAO,IAAM,CAAC,GAAG,qBAAqB,UAAU,EAAE,GAAG;AAAA,oBACnE,OAAO,UAAU;AAAA,oBACjB,gBAAiB,UAAqB;AAAA,kBACxC,CAAC,CAAC;AAAA,gBAEN,CAAC,GAED,MAAM,UAAU;AAAA,cAClB;AAEA,mBAAK,MAAM,WAAW,MAAM,OAAmB;AAAA,YACjD;AACA,iBAAK,qBAAqB,MAAM,QAAQ;AAAA,UAC1C;AACA,kBAAQ,KAAK;AAAA,QACf,CAAC,EACA,MAAM,CAAC,MAAM;AACZ,iBAAO,CAAC;AAAA,QACV,CAAC;AAAA,MACL,CAAC;AAAA,IACH;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IAUA,YAAY,MAAW;AACrB,kBAAK,UAAU,UAAU,MAClB;AAAA,IACT;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IAQA,qBAAqB,MAAW;AAC9B,kBAAK,UAAU,QAAQ,MAChB,KAAK,YAAY,IAAI;AAAA,IAC9B;AAAA;AAAA;AAAA;AAAA;AAAA,IAMA,cAAc;AACZ,aAAO,KAAK,UAAU;AAAA,IACxB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IAOA,mBAAmB;AACjB,aAAO,KAAK,UAAU;AAAA,IACxB;AAAA;AAAA;AAAA;AAAA;AAAA,IAMA,gBAAgB;AACd,kBAAK,UAAU,UAAU,KAAK,UAAU,OACjC;AAAA,IACT;AAAA,IAEA,aAAa;AACX,aAAO,KAAK,MAAM,WAAW,EAAE,IAAI,CAAC,SAAS;AAAA,QAC3C,IAAI,IAAI;AAAA,QACR,OAAO,IAAI;AAAA,MACb,EAAE;AAAA,IACJ;AAAA,IAEA,iBAAiB;AACf,aAAO,KAAK,MAAM,eAAe;AAAA,IACnC;AAAA,IAEA,QAAQ;AACN,WAAK,OAAO,IAAI,KAAK,SAAS,aAAa,KAAK,MAAM,CAAC,CAAC,GACxD,KAAK,qBAAqB,IAAI;AAAA,IAChC;AAAA,EACF;AAGA,EAAiB,OAAO,SACtB,MAAM,OAAO,IAAM,QAAQ;AAAA,IACzB,OAAO;AAAA,MACL,OAAO;AAAA,IACT;AAAA,EACF,CAAC;",
  "names": []
}
